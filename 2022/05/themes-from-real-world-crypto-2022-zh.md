# 来自 Real World Crypto 2022 的主题

上周，来自世界各地的 500 多名密码学家齐聚阿姆斯特丹，参加 Real World Crypto 2022，这是两年多来的第一次面对面会议。

与往年一样，我们派遣了一些研究人员和工程师参加会议，听取演讲并闲聊观察目前主导密码学研究和实际（现实世界！）工程之间关系的主题。

以下是我们从 Real World Crypto 2022 中收集到的主要主题：

1. **可信硬件并不那么可信**：可信硬件的实施者（无论是可信执行环境 (TEE)、HSM 还是安全飞地）继续犯下从根本上违反硬件完整性承诺的工程错误。
2. **安全工具仍然太难使用**：或者“你可以把马牵到水边，但你不能让它运行./configure && make && make install。”
3. **无处不在的侧信道**：当上帝关上一扇门时，他打开了一个侧信道。
4. **加密上下文中的 LANGSEC**：弄清楚你在说哪个协议是计算机科学中的第三个难题。

让我们开始吧！

## 受信任的硬件并不那么值得信赖

可信硬件中的基本非加密漏洞并不是什么新鲜事。多年的漏洞导致英特尔决定从其下一代消费类 CPU 中[删除 SGX](https://www.bleepingcomputer.com/news/security/new-intel-chips-wont-play-blu-ray-disks-due-to-sgx-deprecation/)，而 [ROCA](https://www.cve.org/CVERecord?id=CVE-2017-15361) 在 2017 年影响了[四分之一的 TPM](https://www.theregister.com/2017/10/16/roca_crypto_vuln_infineon_chips/)。

*新的趋势*是可信硬件在*面向消费者的角色*中的流行。普通用户越来越多地（并且在不知不觉中！）在他们的手机和计算机上通过密码管理器和 WebAuthn 等 2FA 方案与安全飞地和 TEE 进行交互。这从根本上扩大了与受信任硬件漏洞相关的风险：受信任硬件的破坏现在对个人用户构成*直接风险*。

这就是 RWC 2022 中的第一个亮点：“**信任在黑暗中消亡：揭示三星的 TrustZone 加密设计**”（[幻灯片](https://iacr.org/submit/files/slides/2022/rwc/rwc2022/58/slides.pdf)、视频、[论文](https://eprint.iacr.org/2022/208.pdf)）。在本次会议中，演讲者描述了 [TEEGRIS](https://developer.samsung.com/teegris/overview.html) （即三星的 TrustZone 操作系统）的两个关键弱点：**IV 重用攻击**，允许攻击者提取受硬件保护的密钥，以及**降级攻击**，即使是最新的和修补过的三星旗舰设备也容易受到攻击到第一种攻击。我们将看看两者。

### TEEGRIS 中的 IV 重用

TEEGRIS 是一个完全独立的操作系统，与“普通”主机操作系统 (Android) 独立运行并并行运行。为了与主机通信，TEEGRIS 提供了一个可信应用程序 (TA)，它在 TEE 内运行，但通过 [Keymaster](https://source.android.com/security/keystore/implementer-ref)（一种由 Google 标准化的命令和响应协议）向普通主机公开资源。

Keymaster 包含“blob”的概念：加密密钥本身已使用 TEE 的密钥材料加密（“包装”）并存储在主机操作系统上。由于打包后的密钥存储在主机上，因此其安全性最终取决于 TEE 在密钥打包期间正确应用加密的安全性。

那么 TEEGRIS Keymaster 是如何包装密钥的呢？使用 AES-GCM！

您会记得，分组密码 (AES) 与操作模式 (GCM) 相结合（通常）有三个参数：

* *密钥*，用于初始化分组密码
* *初始化向量 (IV)*，用于扰乱密文并防止 [ECB 企鹅](https://words.filippo.io/the-ecb-penguin/)（注：密码学的一个著名的隐喻，意即使用ECB方式加密的企鹅图片还能够看出是企鹅）
* 我们打算加密的*明文本身*（在这种情况下，另一个加密密钥）

AES-GCM 的安全性取决于假设 IV 永远不会被重复用于相同的密钥。因此，可以强制在多个“会话”（在本例中为密钥包装）使用密钥和 IV 的攻击者可能会违反 AES-GCM 的安全性。演示者发现三星 Keymaster 实现中的错误违反了两个安全假设：密钥派生函数 (KDF) 不能被操纵以多次生成相同的密钥，以及攻击者无法控制 IV。就是这样：

* 在 Galaxy S8 和 S9 上，用于生成密钥的 KDF 仅使用**攻击者控制的输入**。换句话说，攻击者可以强制给定 Android 应用程序的所有加密 blob 使用**完全相同的 AES 密钥**。在这种情况下，只要攻击者不能强制 IV 重用，这是可以接受的，除非……
* …Android 应用程序可以在生成或导入密钥时设置 IV！三星在 Galaxy S9 上的 Keymaster 实施信任主机传入的 IV，允许攻击者多次使用同一个 IV。

此时，流密码本身的属性为攻击者提供了从另一个 blob 恢复加密密钥所需的一切：恶意 blob、恶意密钥和目标（受害者） blob 的 XOR目标，这是解包的加密密钥！

最终，演示者确定这种特殊攻击仅在 Galaxy S9 上有效：S8 的 Keymaster TA 从攻击者控制的输入生成密钥，但不使用攻击者提供的 IV，从而防止 IV 重用。

该演讲的主持人在 2021 年 3 月报告了此错误，并分配了 [CVE-2021-25444](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-25444)。

### 降级攻击

作为对三星 TrustZone 实施分析的一部分，演示者发现 Galaxy S10、S20 和 S21 设备上的 Keymaster TA 默认使用更新的 blob 格式（“v20-s10”）。这种新格式改变了用于生成 KDF 种子的数据：不是完全由攻击者控制，而是混入随机字节（源自 TEE 本身），防止密钥重用。

但没那么快解决：S10、S20 和 S21 上的 TEE 默认使用“v20-s10”格式，但允许应用程序指定不同 blob 版本。没有任何随机盐的版本（“v15”）是有效的选项之一，所以我们回到了我们从可预测的密钥生成开始的地方。

该演讲的主持人在 2021 年 7 月报告了此错误，并分配了 [CVE-2021-25490](https://nvd.nist.gov/vuln/detail/CVE-2021-25490)。

### 综述

TEE 并不特殊：它们与其他所有东西都受制于相同的加密工程化要求。硬件保证与在它们之上运行的软件一样好，它应该 (1) 使用具有防误用操作模式的现代密码(学)，(2) 最大限度地减少潜在的攻击者对密钥和密钥派生材料的影响，以及 (3) 消除攻击者降级对主机操作系统完全不透明的格式和协议的能力。

## 安全工具仍然太难使用

我们 （Trail of Bits） 是自动化安全工具的忠实拥护者：这就是我们编写和开源工具（如 [dylint](https://github.com/trailofbits/dylint)、[pip-audit](https://github.com/trailofbits/pip-audit)、[siderophile](https://github.com/trailofbits/siderophile) 和 [Echidna](https://github.com/crytic/echidna)）的原因。

这就是为什么我们对“**'它们并不难缓解'：密码库开发人员对定时攻击的看法**”（[幻灯片](https://iacr.org/submit/files/slides/2022/rwc/rwc2022/47/slides.pdf)、视频、[论文](https://eprint.iacr.org/2021/1650.pdf)）中的调查结果感到难过的原因：接受调查的 44 位密码学开发者中，在 27 个主要开源密码项目中，只有 17 个实际使用自动化工具来查找时序漏洞，尽管 100% 的受访参与者都知道时序漏洞及其潜在的严重性。以下是参与者选择不使用自动化工具的一些原因：

* **对风险持怀疑态度**：许多参与者表示怀疑他们是否需要额外的工具来帮助缓解定时攻击，或者是否存在实际的现实世界攻击证明缓解所需的努力是合理的。
* **安装或使用困难**：许多被调查的工具都有复杂的安装、编译和使用说明。当试图使具有过时依赖项的项目在现代系统上运行时，开源维护者表示沮丧，特别是在它们本该最有用的环境中（CI/CD 中的自动测试）。
* **维护状态**：所调查的许多工具都是来自学术著作的源工件，要么未维护，要么维护非常松散。其他人没有容易发现的源工件，只有二进制版本，或者是商业或其他限制性许可。
* **侵入性**：许多工具对他们分析的程序引入了额外的要求，例如特定的构建结构（或程序表示，例如 C/C++ 或仅某些二进制格式）和用于指示秘密和公共值的特殊 DSL。这使得许多工具不适用于用 Python、Rust 和 Go 等语言编写的新项目。
* **开销**：许多工具涉及显著的学习曲线，这会占用开发人员本已有限的太多时间。在手动审查和消除误报和误报、调整工具以提高真阳性率等方面，即使在掌握它们之后，许多也需要大量时间来使用。

也许不直观的是，对工具的认识与它们的使用无关：大多数接受调查的开发人员 (33/44) 都知道一种或多种工具，但实际上只有一半的人选择使用它们。

### 综述

用演示者的话来说，从时序漏洞意识（几乎普遍）到工具意识（大多数开发人员），再到实际工具使用（少数开发人员），存在一条明显的“泄漏管道”。阻止这些泄漏，将需要工具：

* **更易于安装和使用**：这将减少选择工具和实际应用工具之间所需的认知开销。
* **随时可用**：工具必须易于发现，而不需要对活跃的密码学研究非常熟悉；工具应该可以从众所周知的来源（例如公共 Git 主机）下载。

此外，演讲者将**编译器**本身视为一个重要的新领域：编译器始终存在，开发人员已经熟悉，并且是引入更高级技术（如秘密类型）的理想场所。我们（Trail of Bits）碰巧同意！

