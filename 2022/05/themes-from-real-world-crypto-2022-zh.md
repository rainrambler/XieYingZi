# 来自 Real World Crypto 2022 的主题

上周，来自世界各地的 500 多名密码学家齐聚阿姆斯特丹，参加 Real World Crypto 2022，这是两年多来的第一次面对面会议。

与往年一样，我们派遣了一些研究人员和工程师参加会议，听取演讲并闲聊观察目前主导密码学研究和实际（现实世界！）工程之间关系的主题。

以下是我们从 Real World Crypto 2022 中收集到的主要主题：

1. **可信硬件并不那么可信**：可信硬件的实施者（无论是可信执行环境 (TEE)、HSM 还是安全飞地）继续犯下从根本上违反硬件完整性承诺的工程错误。
2. **安全工具仍然太难使用**：或者“你可以把马牵到水边，但你不能让它运行./configure && make && make install。”
3. **无处不在的侧信道**：当上帝关上一扇门时，他打开了一个侧信道。
4. **加密上下文中的 LANGSEC**：弄清楚你在说哪个协议是计算机科学中的第三个难题。

让我们开始吧！

## 受信任的硬件并不那么值得信赖

可信硬件中的基本非加密漏洞并不是什么新鲜事。多年的漏洞导致英特尔决定从其下一代消费类 CPU 中[删除 SGX](https://www.bleepingcomputer.com/news/security/new-intel-chips-wont-play-blu-ray-disks-due-to-sgx-deprecation/)，而 [ROCA](https://www.cve.org/CVERecord?id=CVE-2017-15361) 在 2017 年影响了[四分之一的 TPM](https://www.theregister.com/2017/10/16/roca_crypto_vuln_infineon_chips/)。

*新的趋势*是可信硬件在*面向消费者的角色*中的流行。普通用户越来越多地（并且在不知不觉中！）在他们的手机和计算机上通过密码管理器和 WebAuthn 等 2FA 方案与安全飞地和 TEE 进行交互。这从根本上扩大了与受信任硬件漏洞相关的风险：受信任硬件的破坏现在对个人用户构成*直接风险*。

这就是 RWC 2022 中的第一个亮点：“**信任在黑暗中消亡：揭示三星的 TrustZone 加密设计**”（[幻灯片](https://iacr.org/submit/files/slides/2022/rwc/rwc2022/58/slides.pdf)、视频、[论文](https://eprint.iacr.org/2022/208.pdf)）。在本次会议中，演讲者描述了 [TEEGRIS](https://developer.samsung.com/teegris/overview.html) （即三星的 TrustZone 操作系统）的两个关键弱点：**IV 重用攻击**，允许攻击者提取受硬件保护的密钥，以及**降级攻击**，即使是最新的和修补过的三星旗舰设备也容易受到攻击到第一种攻击。我们将看看两者。

### TEEGRIS 中的 IV 重用

TEEGRIS 是一个完全独立的操作系统，与“普通”主机操作系统 (Android) 独立运行并并行运行。为了与主机通信，TEEGRIS 提供了一个可信应用程序 (TA)，它在 TEE 内运行，但通过 [Keymaster](https://source.android.com/security/keystore/implementer-ref)（一种由 Google 标准化的命令和响应协议）向普通主机公开资源。

Keymaster 包含“blob”的概念：加密密钥本身已使用 TEE 的密钥材料加密（“包装”）并存储在主机操作系统上。由于打包后的密钥存储在主机上，因此其安全性最终取决于 TEE 在密钥打包期间正确应用加密的安全性。

那么 TEEGRIS Keymaster 是如何包装密钥的呢？使用 AES-GCM！

您会记得，分组密码 (AES) 与操作模式 (GCM) 相结合（通常）有三个参数：

* *密钥*，用于初始化分组密码
* *初始化向量 (IV)*，用于扰乱密文并防止 [ECB 企鹅](https://words.filippo.io/the-ecb-penguin/)（注：密码学的一个著名的隐喻，意即使用ECB方式加密的企鹅图片还能够看出是企鹅）
* 我们打算加密的*明文本身*（在这种情况下，另一个加密密钥）

AES-GCM 的安全性取决于假设 IV 永远不会被重复用于相同的密钥。因此，可以强制在多个“会话”（在本例中为密钥包装）使用密钥和 IV 的攻击者可能会违反 AES-GCM 的安全性。演示者发现三星 Keymaster 实现中的错误违反了两个安全假设：密钥派生函数 (KDF) 不能被操纵以多次生成相同的密钥，以及攻击者无法控制 IV。就是这样：

* 在 Galaxy S8 和 S9 上，用于生成密钥的 KDF 仅使用**攻击者控制的输入**。换句话说，攻击者可以强制给定 Android 应用程序的所有加密 blob 使用**完全相同的 AES 密钥**。在这种情况下，只要攻击者不能强制 IV 重用，这是可以接受的，除非……
* …Android 应用程序可以在生成或导入密钥时设置 IV！三星在 Galaxy S9 上的 Keymaster 实施信任主机传入的 IV，允许攻击者多次使用同一个 IV。

此时，流密码本身的属性为攻击者提供了从另一个 blob 恢复加密密钥所需的一切：恶意 blob、恶意密钥和目标（受害者） blob 的 XOR目标，这是解包的加密密钥！

最终，演示者确定这种特殊攻击仅在 Galaxy S9 上有效：S8 的 Keymaster TA 从攻击者控制的输入生成密钥，但不使用攻击者提供的 IV，从而防止 IV 重用。

该演讲的主持人在 2021 年 3 月报告了此错误，并分配了 [CVE-2021-25444](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-25444)。

### 降级攻击

作为对三星 TrustZone 实施分析的一部分，演示者发现 Galaxy S10、S20 和 S21 设备上的 Keymaster TA 默认使用更新的 blob 格式（“v20-s10”）。这种新格式改变了用于生成 KDF 种子的数据：不是完全由攻击者控制，而是混入随机字节（源自 TEE 本身），防止密钥重用。

但没那么快解决：S10、S20 和 S21 上的 TEE 默认使用“v20-s10”格式，但允许应用程序指定不同 blob 版本。没有任何随机盐的版本（“v15”）是有效的选项之一，所以我们回到了我们从可预测的密钥生成开始的地方。

该演讲的主持人在 2021 年 7 月报告了此错误，并分配了 [CVE-2021-25490](https://nvd.nist.gov/vuln/detail/CVE-2021-25490)。

### 综述

TEE 并不特殊：它们与其他所有东西都受制于相同的加密工程化要求。硬件保证与在它们之上运行的软件一样好，它应该 (1) 使用具有防误用操作模式的现代密码(学)，(2) 最大限度地减少潜在的攻击者对密钥和密钥派生材料的影响，以及 (3) 消除攻击者降级对主机操作系统完全不透明的格式和协议的能力。

## 安全工具仍然太难使用

我们 （Trail of Bits） 是自动化安全工具的忠实拥护者：这就是我们编写和开源工具（如 [dylint](https://github.com/trailofbits/dylint)、[pip-audit](https://github.com/trailofbits/pip-audit)、[siderophile](https://github.com/trailofbits/siderophile) 和 [Echidna](https://github.com/crytic/echidna)）的原因。

这就是为什么我们对“**'它们并不难缓解'：密码库开发人员对定时攻击的看法**”（[幻灯片](https://iacr.org/submit/files/slides/2022/rwc/rwc2022/47/slides.pdf)、视频、[论文](https://eprint.iacr.org/2021/1650.pdf)）中的调查结果感到难过的原因：接受调查的 44 位密码学开发者中，在 27 个主要开源密码项目中，只有 17 个实际使用自动化工具来查找时序漏洞，尽管 100% 的受访参与者都知道时序漏洞及其潜在的严重性。以下是参与者选择不使用自动化工具的一些原因：

* **对风险持怀疑态度**：许多参与者表示怀疑他们是否需要额外的工具来帮助缓解定时攻击，或者是否存在实际的现实世界攻击证明缓解所需的努力是合理的。
* **安装或使用困难**：许多被调查的工具都有复杂的安装、编译和使用说明。当试图使具有过时依赖项的项目在现代系统上运行时，开源维护者表示沮丧，特别是在它们本该最有用的环境中（CI/CD 中的自动测试）。
* **维护状态**：所调查的许多工具都是来自学术著作的源工件，要么未维护，要么维护非常松散。其他人没有容易发现的源工件，只有二进制版本，或者是商业或其他限制性许可。
* **侵入性**：许多工具对他们分析的程序引入了额外的要求，例如特定的构建结构（或程序表示，例如 C/C++ 或仅某些二进制格式）和用于指示秘密和公共值的特殊 DSL。这使得许多工具不适用于用 Python、Rust 和 Go 等语言编写的新项目。
* **开销**：许多工具涉及显著的学习曲线，这会占用开发人员本已有限的太多时间。在手动审查和消除误报和误报、调整工具以提高真阳性率等方面，即使在掌握它们之后，许多也需要大量时间来使用。

也许不直观的是，对工具的认识与它们的使用无关：大多数接受调查的开发人员 (33/44) 都知道一种或多种工具，但实际上只有一半的人选择使用它们。

### 综述

用演示者的话来说，从时序漏洞意识（几乎普遍）到工具意识（大多数开发人员），再到实际工具使用（少数开发人员），存在一条明显的“泄漏管道”。阻止这些泄漏，将需要工具：

* **更易于安装和使用**：这将减少选择工具和实际应用工具之间所需的认知开销。
* **随时可用**：工具必须易于发现，而不需要对活跃的密码学研究非常熟悉；工具应该可以从众所周知的来源（例如公共 Git 主机）下载。

此外，演讲者将**编译器**本身视为一个重要的新领域：编译器始终存在，开发人员已经熟悉，并且是引入更高级技术（如秘密类型）的理想场所。我们（Trail of Bits）碰巧同意！

## 无处不在的侧信道

侧信道漏洞的伟大之处在于它们令人难以置信的普遍性：似乎有一个看似永无止境的、越来越有创意的技术库，用于从目标机器中提取信息。

侧信道通常沿两个维度进行描述：**被动-主动**（即攻击者是否需要与目标交互，以及在何种程度上？）和**本地-远程**（即攻击者是否需要在目标的物理附近？）。因此，从攻击者的角度来看，**远程、被动**侧信道是“两全其美”：它们完全隐蔽，不需要物理存在，使受害者（原则上）无法检测到它们。

我们喜欢“**借给我你的耳朵：PC 上的被动远程物理侧信道**”（视频、[论文](https://www.usenix.org/system/files/sec22summer_genkin.pdf)）中描述的侧信道。总结一下：

* 演示者观察到，在笔记本电脑上，板载麦克风物理连接到音频接口（因此连接到 CPU）。数字逻辑控制着有意的数据流，但它是电线，因此，潜在还有无意的噪音。
* 实际上，这意味着板载麦克风可能充当 CPU 本身的 EM 探头！
* 我们通过互联网将我们的音频分享给可能不受信任的各方：公司会议、会议、与朋友和家人的 VoIP、视频游戏的语音聊天等等……
* …那么我们可以从这些数据中提取任何感兴趣的东西吗？

演讲者提供了三个案例研究：

* 网站识别：受害者在通过 VoIP 通话时浏览网站，攻击者（正在与受害者通话）想知道受害者当前在哪个网站上。
	* 结果：使用带有 14 路分类器的卷积神经网络（针对 14 个热门新闻网站），演示者能够达到 96% 的准确率。
* 加密密钥恢复：受害者在通过 VoIP 通话时在她的本地机器上执行 ECDSA 签名，攻击者想要泄露用于签名的密钥。
	* 结果：演示者能够使用与 Minerva 相同的侧信道弱点，但无需本地仪器。即使有后处理噪音，他们也展示了大约 20,000 次签名操作后的密钥提取。
* CS:GO wallhacks：受害者正在玩在线第一人称射击游戏，同时通过 VoIP 与其他玩家交谈，攻击者想知道受害者在游戏地图上的实际位置。
	* 结果：当受害者隐藏在不透明的游戏内物体（例如汽车）后面时，可以在频谱图中直观地识别出明显的“斑马纹”。演示者观察到，这规避了标准的“反作弊”缓解措施，因为没有操纵客户端代码来揭示受害者在游戏中的位置。

### 综述

侧信道是不断给予的礼物：它们难以预测和缓解，它们破坏了抽象上完全合理的加密方案。

演示者正确地指出，这种特殊的攻击颠覆了关于物理侧信道的传统假设：它们不能被远程利用，因此可以从攻击者纯粹是远程的威胁模型中排除。

## 加密上下文中的 LANGSEC

LANGSEC是 "安全的语言理论方法"：它将许多（大多数？）可利用的软件错误归结为对潜在的不可信任的输入的特别解释，并建议我们通过与仅由有效或预期输入得出的形式语言进行比较来解析不可信任的输入。

这种方法与应用密码学中经常出现的错误类型极为相关：

* 具有复杂底层格式（如 DER）的复杂方案（如 PKCS#1 v1.5）继续产生可利用的漏洞：[Bleichenbacher 2006](https://mailarchive.ietf.org/arch/msg/openpgp/5rnE9ZRN1AokBVj3VqblGlP63QE/) 年的攻击年复一年地出现。
* 复杂的协议（如 TLS）和升级/降级行为也会产生可利用的错误：[POODLE](https://www.openssl.org/~bodo/ssl-poodle.pdf) 降级到 SSL 3.0，[实现错误](https://dl.acm.org/doi/pdf/10.1145/3386367.3431310)可能导致 TLS 1.3 降级。

在今年的RWC会议上，我们看到的不是一个，而是两个与LANGSEC相关的讲座!

### 应用层协议的混乱

“**ALPACA：应用层协议的混乱--分析和缓解TLS认证中的裂缝**”演讲（[幻灯片](https://iacr.org/submit/files/slides/2022/rwc/rwc2022/46/slides.pdf)、视频、[论文](https://www.usenix.org/system/files/sec21-brinkmann.pdf)），从他们对TLS的设计决定的观察开始：因为TLS从根本上是独立于应用和协议的，它对两个端点应该如何进行通信没有直接的概念。换句话说，TLS只关心在两台机器之间建立一个加密的通道，而不关心（必然）哪些机器或这些机器上的哪些服务正在实际通信。

在 Web 上使用时，TLS 证书通常绑定到域，以防止攻击者将用于 safe.com 的流量重定向到恶意网站。但这并不总是足够的：

* 通配符证书很常见：如果该流量使用允许 *.example.com 的证书加密，则控制恶意.example.com 的攻击者可能能够重定向来自 safe.example.com 的流量。
* 证书可以声明许多主机，包括已被恶意攻击者获取或破坏的主机：safe.example.com 的证书也可能允许攻击者可能控制的 safe.example.net。
* 最后，也许最有趣的是，证书**没有指定**他们希望通过哪个服务和/或端口进行身份验证，这为攻击者创造了**将流量重定向到同一主机上的不同服务的机会**。

为了让攻击者更容易做到这一点，主机经常使用与 HTTP 大致相似的协议运行多个服务。演讲者针对三种不同的攻击技术评估了其中四种（FTP、SMTP、IMAP 和 POP3）：

* **反射**：中间人攻击者将跨域 HTTPS 请求重定向到同一主机上的不同服务，导致该服务将受信任的响应“反射”回受害者。
* **下载**：攻击者将恶意数据存储在运行同一主机的服务上，并诱使随后的 HTTPS 请求下载并呈现该数据，类似于存储的 XSS 攻击。
* **上传**：攻击者破坏了在同一主机上运行的服务，并将后续的 HTTPS 请求重定向到服务，导致敏感内容（例如 cookie 标头）上传到服务以供以后检索。

接下来，演讲者评估了流行的网络浏览器和用于 FTP、SMTP、IMAP 和 POP3 的应用程序服务器，并确定：

* **所有浏览器**都容易受到针对一个或多个 FTP 服务器包的至少两种攻击技术（FTP 上传 + FTP 下载）的攻击。
* **Internet Explorer 和 Microsoft Edge** 尤其容易受到攻击：所有利用方法都适用于一个或多个服务器包。

这一切都太棒了，但是有多少实际的服务器是易受攻击的？事实证明，相当多的：在运行启用 TLS 的应用程序服务器（如 FTP 或 SMTP）的 **200 万台**唯一主机中，超过 **140 万台**（或 69%）也在运行 HTTPS，这使得它们容易受到一般跨协议攻击。演示者进一步将其范围缩小到具有已知可利用的应用程序服务器的主机（例如旧版本的 ProFTPD），并确定了超过 114,000 个可能受到攻击的 HTTPS 主机。

那么我们能做些什么呢？主持人有一些想法：

* 在应用服务器级别，我们可以应用一些合理的对策：像 FTP 这样的协议应该对它们接受的内容更加严格（例如，拒绝接受看起来像 HTTP 的请求），并且应该更加积极地终止不接受的请求。类似于有效的 FTP 会话。
* 在证书级别，组织应警惕通配符和多域证书，并应避免为启用 TLS 的应用程序共享主机。
* 最后，在协议级别，像 ALPN 这样的 TLS 扩展允许客户端指定他们希望与之通信的应用程序级别的协议，从而可能允许目标应用程序服务器（如 SMTP）拒绝重定向的连接。这要求应用程序服务器不要忽略它们经常这样做的 ALPN。

概述

* 尽管多年来广为人知并广为人知，但今天仍然可能发生跨协议攻击！更糟糕的是，微不足道的扫描揭示了数十万个运行在共享 HTTPS 上的可利用应用程序服务器，这使得利用的门槛非常低。
* 这个空间还没有被充分探索：像 SMTP 和 FTP 这样的应用协议是明显的目标，因为它们与 HTTP 相似，但更新的协议也出现在互联网服务中，比如 VPN 协议和 DTLS。

### “隔离时安全，组合时易受攻击”：OpenPGP 中的 ElGamal

“On the (in) security of ElGamal in OpenPGP”（[幻灯片](https://iacr.org/submit/files/slides/2022/rwc/rwc2022/76/slides.pdf)、视频、[论文](https://eprint.iacr.org/2021/923.pdf)）的演讲者讨论了另一个与 LANGSEC 相邻的问题：隔离时安全但互操作时不安全的标准或协议。

演讲者考虑了在 [OpenPGP](https://datatracker.ietf.org/doc/html/rfc4880) (RFC 4880) 的实现中的 [ElGamal](https://en.wikipedia.org/wiki/ElGamal_encryption)，因为它在 OpenPGP 所需的非对称方案中具有独特的地位：

* 与 RSA (PKCS#1) 和 ECDH ([RFC 6637](https://datatracker.ietf.org/doc/html/rfc6637)) 不同，ElGamal 没有正式或官方的规范！
* ElGamal 的两个“官方”参考资料是[原始论文本身](https://ieeexplore.ieee.org/stamp/stamp.jsp?tp=&arnumber=1057074)和 1997 年版的《应用密码学手册》，它们在参数选择技术上存在分歧！ OpenPGP RFC 引用了两者；演讲者得出的结论是，RFC 打算让原始论文具有权威性。

（顺便说一下，你知道这仍然是加密协议的一个常见问题，包括零知识、MPC 和阈值方案吗？如果这听起来很可怕（确实）并且是你想避免的事情（确实)，您应该查看 [ZKDocs](https://www.zkdocs.com/)！我们已经完成了了解零知识生态系统中协议和方案设计的最佳实践的艰苦工作，因此您不必这样做。）

演示者评估了支持 ElGamal 密钥生成的三种 PGP 实现（[GnuPG](https://gnupg.org/)、[Botan](https://botan.randombit.net/) 和 [libcrypto++](https://www.cryptopp.com/wiki/Linux)），发现没有一个在参数选择方面遵守 RFC 4880：所有三种都使用不同的方法来生成素数。

但这仅仅是开始：许多 OpenPGP 实现是专有的或受长期变化的影响，因此很难仅从开源代码库评估与标准的实际偏差。为了了解真实世界，演示者调查了超过 800,000 个真实世界的 ElGamal 密钥，并发现：

* 大多数密钥似乎是使用“安全素数”技术生成的。
* 很大一部分人似乎在使用 [Lim-Lee 素数](http://citeseerx.ist.psu.edu/viewdoc/download?rep=rep1&type=pdf&doi=10.1.1.44.5296)。
* 一小部分人似乎在使用 Schnorr 或类似的素数。
* 只有 5% 的人似乎在使用“准安全”素数，这可能表明有意符合 RFC 4880 的素数生成要求。

这些素数生成技术中的每一个（可能）在隔离时都是安全的……但不是在组合时：Go、GnuPG和libcrypto++对ElGamal公钥的加密实现都很容易受到侧信道攻击，使明文恢复，因为ElGamal钥匙在野外使用的素数生成技术是意想不到的。

底线：在被调查的大约 800,000 个密钥中，大约 2,000 个由于用于生成它们的“短指数”优化而容易受到实际明文恢复的影响。为了验证他们攻击的可行性，演示者在对执行加密的 GPG 进行了大约 2.5 小时的侧信道分析后，成功恢复了加密消息的明文。

### 综述

* ElGamal 是一种古老的、易于理解的密码系统，其参数和安全属性在纸面上很简单（很像 RSA），但在现实世界的实现中存在很大的模糊性和多样性。标准对安全很重要，ElGamal 需要一个真正的标准！
* 密码系统的安全性是有害的：通过您自己的输入来了解潜在的旁道是不够的；签名和加密方案还必须能够抵抗不良（甚至只是异常）生成的密钥、证书等。

## 荣誉奖

在今年的 RWC 上有很多非常棒的演讲——太多了，无法在一篇博文中重点介绍。我们真正喜欢的其他一些包括：

* “**零知识中间盒**”（[幻灯片](https://datatracker.ietf.org/meeting/112/materials/slides-112-tls-zero-knowledge-proofs-meet-tls-01)、视频、[论文](https://eprint.iacr.org/2021/1022.pdf)）：公司目前依靠 TLS 中间盒（和其他网络管理技术，如 DNS 过滤）来执行公司数据和安全策略。中间盒是强大的工具，它们会受到侵犯隐私的影响（以及随后被精明的用户规避，破坏了它们的功效）。本次演讲提供了一个有趣（尽管仍处于试验阶段）的解决方案：使用中间盒来验证策略合规性的零知识证明，而无需实际解密（因此，损害）任何 TLS 会话！此解决方案的关键结果是在不影响用户的 DNS-over-TLS 会话的情况下遵守 DNS 策略，每次验证的开销约为 5 毫秒（对应于一次 DNS 查找）。
* “**在为时已晚之前提交隐写术**”（[幻灯片](https://cs-people.bu.edu/kaptchuk/talks/RWC22.pdf)，视频）：隐写术是密码学/密码分析世界的丑小鸭，对隐写术和隐写分析的研究在很大程度上已经枯竭。 Kaptchuk 认为，这种兴趣下降是没有根据的，隐写术将在与压制性国家之间以及在压制性国家内部进行不可否认的交流中发挥重要作用。为此，该演讲提出了 Meteor，这是一种加密安全的隐写方案，它使用生成语言模型将消息隐藏在看似合理的人类语言句子中。

2023年见！

